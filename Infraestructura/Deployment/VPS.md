# VPS
Para este ejemplo se ha contratado un VPS con OVH, el mas basico con 1core de CPU, 1GB de RAM y 20GB de Almacenmiento, el despliegue se va a hacer con Docker.

Un VPS es un entorno virtualizado en un servidor de una empresa externa que contiene un sistema operativo instalado(en este caso debian) el cual tenemos que configurar en su totalidad.

## Primera toma de contacto 
Accedemos al portal de OVH
<img width="731" alt="image" src="https://github.com/g4rc1ss/ApuntesProgramacion/assets/28193994/f7703bf0-ff19-4c0a-a2c0-9f24461fa029">

Basicamente para lo que necesitamos estar aqui es para obtene los datos como la ip para acceder al servidor, para conectar con la maquina se realiza a traves de una conexion `SSH` y toda configuracion se hace mediante terminal o algun gestor GUI que lo permita.

<img width="731" alt="image" src="https://github.com/g4rc1ss/ApuntesProgramacion/assets/28193994/29752b94-427b-4aa7-80db-fa01cda28470">
- `sudo su`: para tener acceso root termporalmente y no andar metiendo `sudo` todo el rato(no es lo mas recomendable, la verdad)
- `apt-get update`: Actualizamos el registro de dependencias y sus versiones
- `apt-get upgrade`: Actualizamos las dependencias con las nuevas versiones del registro

> Tambien es recomendable ejecutar el comando `passwd` para cambiar la password, si es que nos han dado una por defecto(que suele ser lo habitual)

## Iptables
Para poder agregar un poco de seguridad, configuramos un firewall con `iptables`

Creamos un archivo llamado `iptables` y escribimos lo siguiente
```bash
# Generated by xtables-save v1.8.2 on Fri Jul 14 09:58:16 2023
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-USER - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
-A INPUT -i lo -j ACCEPT
# NGINX
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p udp -m udp --dport 53 -j ACCEPT
# grafana
-A INPUT -p tcp -m tcp --dport 3000 -j ACCEPT
# Zipkin
-A INPUT -p tcp -m tcp --dport 9411 -j ACCEPT
# SEQ
-A INPUT -p tcp -m tcp --dport 5341 -j ACCEPT
# Open Telemetry
-A INPUT -p tcp -m tcp --dport 8889 -j ACCEPT
# Prometheus
-A INPUT -p tcp -m tcp --dport 9090 -j ACCEPT
# API NodeJS
-A INPUT -p tcp -m tcp --dport 55434 -j ACCEPT
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-USER -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
COMMIT
# Completed on Fri Jul 14 09:58:16 2023
# Generated by xtables-save v1.8.2 on Fri Jul 14 09:58:16 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A DOCKER -i docker0 -j RETURN
COMMIT
```
Cargamos las reglas con el comando `sudo iptables-restore < archivoIptablesCreadoPorNosotros`.

> Para que se ejecuten las reglas cada vez que reiniciamos el servidor instalamos el paquete `iptables-persistent` y ejecutamos el comando `sudo iptables-save > /etc/iptables/rules.v4`

##  Despliegue de la app con DOCKER
En este ejemplo se va a desplegar una aplicacion .NET con Docker-Compose

Para poder desplegar la aplicacion con docker, aparte de tener docker, necesitamos el codigo que se va a desplegar junto con los dockerfile.

Hay varias formas de hacerlo:

- **GITHUB**
La forma mas comun es hacerlo a traves del control del versiones, puesto que se pueden subir releases, etc.

En este caso usare GITHUB y la forma de descargarlo seria con el siguiente comando:
```bash
# Si queremos descargar directamente desde la rama(branch) que se va a desplegar
curl -L https://github.com/usuario/proyecto/archive/refs/heads/main.zip -o ./project.zip

# Si tenemos la aplicacion en Releases
curl -L https://github.com/g4rc1ss/Dotnet-Web-Clean-Architecture-Skeleton/archive/refs/tags/1.0.zip -o ./project.zip
```

- **SFTP**
Si preferimos mandar directamente el codigo nosotros, se puede establecer una conexion `sftp` para la transferencia de ficheros.

Comprimimos nuestro proyecto en un zip por ejemplo para la transferencia y ejecutamos los comandos:
```bash
sftp usuario@direccion.ip
put /ruta/nuestro/archivo ./ruta/donde/colocarlo
```

Una vez tenemos el projecto en zip, lo descomprimimos con el comando `unzip`

## Desplegando con Docker
En este caso tenemos las variables de configuracion en un archivo `.env`.
> En el proyecto hay creados unos archivos configurados para los diferentes entornos, no obstante deberiamos de tener el archivo en el VPS en una ruta diferente y proteger el archivo

Para poder ejecutar esta aplicacion tengo un script en powershell, por tanto hemos de instalarlo en el servidor debian
```bash
# Download the Microsoft repository GPG keys
wget https://packages.microsoft.com/config/debian/10/packages-microsoft-prod.deb

# Register the Microsoft repository GPG keys
sudo dpkg -i packages-microsoft-prod.deb

# Update the list of products
sudo apt-get update

# Install PowerShell
sudo apt-get install -y powershell

# Start PowerShell
pwsh
```
> La info de los comandos es recogida en la pagina oficial de [Microsoft](https://learn.microsoft.com/es-es/powershell/scripting/install/installing-powershell-on-linux?view=powershell-7.3)
> Estos comandos son para debian 10, si hay otra version, habra que consultarla en la doc oficial

Nos ubicamos en la carpeta del proyecto donde tenemos el fichero de docker y ejecutamos el comando, si todo va bien, este compilara la imagen, descargara las que necesite y ejecutara la aplicacion exponiendo el puerto que le hemos indicado
> Si nos sale un error del estilo: `error getting credentials - err: exit status 1, out: GDBus.Error:org.freedesktop.DBus.Error.ServiceUnknown: The name org.freedesktop.secrets was not provided by any .service files` tendremos que instalar el paquete `apt -y install gnome-keyring`
